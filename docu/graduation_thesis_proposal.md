# 毕业设计开题报告

**论文题目：** 面向工业机器人的嵌入式系统可靠固件更新架构设计  
**学院：** 电子与信息工程学院  
**专业：** 微电子科学与工程  
**学生姓名：** 杨荣宝  
**指导教师：** 刘春平  

## 一、 本选题的意义及国内外发展状况

### 1.1 选题背景与意义
随着“中国制造2025”战略的推进，工业机器人的部署规模日益扩大。在实际产线中，工业机器人往往需要连续作业，停机维护成本极高。传统的固件更新方式通常要求设备进入特定的Bootloader模式等待数据传输，这意味着在漫长的固件下载过程中（尤其是通过低速UART接口传输大数据时），设备必须停止生产，造成了宝贵的生产时间浪费。

为了解决这一痛点，设计一种基于RTOS（实时操作系统）的“无感”差分固件更新架构显得尤为重要。本课题致力于实现“业务运行与固件下载并行”的机制：即不管新老固件，只要是基于RTOS构建，就可以在机器人执行正常控制任务的同时，利用空闲时间片通过UART接收差分包，并在系统下一次上电重启时自动完成固件的重构与切换。这种设计不仅通过差分技术解决了UART带宽瓶颈，更通过后台接收技术消除了固件下载阶段的设备停机时间，最大限度地保障了工业生产的连续性与效率。

### 1.2 国内外发展状况
**国外现状：**
高端工业控制器（如Siemens Simatic系列）普遍具备“运行模式下下载（Download in Run）”的能力。在嵌入式软件架构上，AWS FreeRTOS OTA等方案提倡将OTA作为OS的一个低优先级后台服务运行。技术上，利用RTOS的抢占式调度，将通信任务与实时控制任务解耦，是实现高可用性系统的标准做法。

**国内现状：**
国内中低端工业控制器仍多采用“停机更新”模式，即更新时需人工复位设备进入维护模式。虽然部分厂家开始尝试基于OS的IAP技术，但在资源受限的MCU上同时实现多分区内存管理、差分包后台接收以及重启后的自动还原，仍缺乏标准化的架构参考。本课题拟在这一领域进行深入探索，结合工业机器人的实际需求，设计一套低成本、高效率的嵌入式更新方案。

## 二、 研究内容

本课题将构建一个包含Bootloader、基于RTOS的用户应用程序（App）、上位机工具的完整生态，核心在于利用Flash五分区布局与RTOS多任务机制，实现固件的“静默传输”与“延迟激活”。

### 2.1 嵌入式Flash内存分区规划
为支持后台接收与乒乓升级，以STM32H743IIT6为例，将其2MB的Flash划分为五个独立区域：
1.  **Bootloader区**：负责上电引导、差分还原运算及分区跳转。
2.  **参数区（Parameters）**：存储系统状态（如当前运行分区索引、更新请求标志、差分包大小、CRC校验值）。
3.  **差分包暂存区（Diff_Patch）**：独立的数据存储区，用于存放RTOS运行时接收到的差分文件。
4.  **应用A区（App_A）**：执行区之一。
5.  **应用B区（App_B）**：执行区之二（备份/待切换区）。

### 2.2 基于RTOS的运行时差分包接收机制（核心创新点）
本部分是研究的重点，旨在实现在不影响正常工作的情况下接收差分包：
*   **多任务调度设计**：在RTOS（如FreeRTOS或uCOS）中设计一个低优先级的“OTA Agent”任务。
*   **并发处理**：当工业机器人的高优先级任务（如运动控制、IO扫描）运行时，OTA任务处于挂起状态；一旦系统有空闲时间片，OTA任务即通过UART中断或DMA接收上位机下发的差分包数据。
*   **流式写入**：OTA任务将接收到的数据实时写入Diff_Patch分区。由于Flash写入会暂停CPU总线，需精心设计写入策略（如分片写入），确保Flash操作时间极短，不阻塞高优先级的实时控制中断。
*   **状态标记**：当差分包接收完毕并校验无误后，OTA任务仅在参数区写入“更新就绪”标志，不立即重启，让机器人继续完成当前班次的生产任务。

### 2.3 Bootloader差分还原与自动更新
设计智能Bootloader，作为更新动作的执行者：
*   **上电检测**：系统上电或复位时，Bootloader首先检查参数区。若检测到“更新就绪”标志，则进入更新流程。
*   **镜像重构**：Bootloader读取当前旧App分区（如App_A）的内容，结合Diff_Patch区的数据，利用差分算法还原出新固件，并将其写入空闲分区（如App_B）。
*   **原子切换**：新固件校验通过后，Bootloader修改参数区的“活动分区指针”指向App_B，并在随后跳转运行。至此，系统完成自动更新。

### 2.4 上位机差分生成与传输
*   开发PC端工具，实现新旧Bin文件的差分运算，生成高压缩比的Patch文件。
*   设计UART传输协议，支持流控，防止上位机发送过快导致RTOS接收缓冲区溢出。

## 三、 研究方法、手段及步骤

### 3.1 研究方法
1.  **任务优先级分析法**：根据工业机器人的实时性要求（如1ms控制周期），合理分配OTA任务的优先级与堆栈大小，确保下载过程绝不影响电机控制。
2.  **状态机设计法**：设计清晰的“空闲-接收中-校验完成-待重启-还原中”状态流转模型。
3.  **双缓冲区机制**：在RAM中开辟双缓冲，配合UART DMA传输，实现数据接收与Flash写入的流水线处理。

### 3.2 研究手段（工具与平台）
*   **硬件平台**：STM32F4/F7系列MCU（支持Flash双区操作者更佳，若不支持则采用逻辑分区）。
*   **操作系统**：FreeRTOS 或 RT-Thread。
*   **开发环境**：Keil MDK, STM32CubeMX。
*   **差分算法**：基于HDiffPatch或bsdiff裁剪的嵌入式C库。

### 3.3 研究步骤
1.  **第一阶段（第1-2周）：架构定义与RTOS环境搭建**
    *   完成Flash五分区地址划分。
    *   在MCU上移植RTOS，并建立基础的LED闪烁（模拟控制任务）与UART通信任务。
2.  **第二阶段（第3-4周）：RTOS后台接收功能开发**
    *   开发OTA Agent任务：实现UART数据的DMA接收、协议解析与Flash编程算法。
    *   压力测试：在模拟高负载（如高频定时器中断）的情况下，验证后台接收差分包的完整性，确保不丢包、不影响中断响应。
3.  **第三阶段（第5-7周）：Bootloader还原引擎开发**
    *   独立开发Bootloader，实现“读取旧区+读取Patch区 = 写入新区”的逻辑。
    *   打通参数区交互：APP写标志 -> 重启 -> Bootloader读标志。
4.  **第四阶段（第8-10周）：系统联调与全流程验证**
    *   模拟完整场景：机器人在“工作”状态下，PC端下发差分包，接收完成后手动断电重启，验证系统是否自动升级到了新版本。
5.  **第五阶段（第11-13周）：论文撰写**
    *   总结“运行时接收”对系统实时性的影响分析数据，完成论文。

## 四、 参考文献

[1]罗晶晶.基于4G网络的嵌入式设备远程升级系统设计与实现[D].吉林大学,2021.DOI:10.27162/d.cnki.gjlin.2021.004514.  
[2]黄志贤,王宜怀,程宏玉.嵌入式设备的增量式远程更新系统设计[J].现代电子技术,2020,43(22):157-160+164.DOI:10.16652/j.issn.1004-373x.2020.22.039.  
[3]许梦茹.车载嵌入式设备的远程升级系统设计[D].中国计量大学,2017.  
[4]关峰,谢晓明.嵌入式设备软件更新系统设计与实现[J].电子测试,2013,(20):11-12.  
[5]马小陆,方百川.机器人底盘控制系统的在线升级技术研究[J].机器人技术与应用,2025,(02):33-38.  
[6]吕小少.软件在线升级劫持漏洞快速检测技术研究[D].战略支援部队信息工程大学,2021.DOI:10.27188/d.cnki.gzjxu.2021.000081.  
[7]肖怡乐,杨立新,白志华,等.下一代多芯智能电表中程序在线升级的技术方案[J].单片机与嵌入式系统应用,2019,19(12):55-57+80.  
[8]唐鹏程,汪旭明,胡力.用IAP技术在线升级STM32单片机固件[J].吉首大学学报(自然科学版),2019,40(01):21-26.DOI:10.13438/j.cnki.jdzk.2019.01.006.  
[9]张博强,卜祥蕊.嵌入式设备远程在线升级技术研究[J].中国新通信,2018,20(12):149.  
[10]黄友胜.基于ISP的矿用传感器在线升级技术[J].煤矿安全,2019,50(01):140-143.DOI:10.13347/j.cnki.mkaq.2019.01.035.  
[11]赵炯,贾培源,李中山,等.嵌入式设备远程在线升级技术[J].计算机工程,2010,36(12):262-264.  
[12]黄绳雄,张荣芬.嵌入式设备远程在线升级技术的研究[J].电子设计工程,2012,20(09):172-174+177.DOI:10.14022/j.cnki.dzsjgc.2012.09.037.  
[13]姜晓梅,李祥和,任朝荣,等.基于ARM的IAP在线及远程升级技术[J].计算机应用,2008,(02):519-521.  
[14]叶利华,陶宏才,梁田.基于COM的软件在线升级技术[J].成都信息工程学院学报,2005,(01):73-75.  
[15]李维,禹云辉,肖秋.小内存嵌入式设备软件的差分升级设计[J].单片机与嵌入式系统应用,2023,23(05):20-24.  
[16]陈德富,周旭文,邱宝象,等.嵌入式设备固件差分升级的策略设计[J].单片机与嵌入式系统应用,2022,22(07):7-9.  
[17]Zhang J ,Chen P .FirmUpdate: Automated multi-phase static analysis for detecting firmware update vulnerabilities in IoT Linux-based firmware[J].Computers & Security,2026,160104735-104735.DOI:10.1016/J.COSE.2025.104735.  
[18]Oktian E Y ,Le H T T ,Jo U , et al.Secure decentralized firmware update delivery service for Internet of Things[J].Internet of Things,2024,26101136-.DOI:10.1016/J.IOT.2024.101136.  
[19]Appiah B ,Commey D ,Osei I , et al.Secure IoT firmware updates against supply chain attacks[J].The Journal of Supercomputing,2025,81(5):695-695.DOI:10.1007/S11227-025-07126-9.    
